<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Sleepy Bobby - Audio Setup</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bobby">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #38bdf8;
            --bird-grey: #b8b0a5; --bird-dark-grey: #8d7e71; --bird-orange: #e65a28; --branch-brown: #8b5d43;
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; background: var(--bg); font-family: system-ui, sans-serif; color: var(--text); }
        body { display: flex; align-items: center; justify-content: center; }

        .anim-container { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        #bgAnimContainer { z-index: 1; } 
        #animContainer { z-index: 999; }

        .container { width: 100%; max-width: 380px; padding: 20px; text-align: center; position: relative; z-index: 10; }
        .card { background: var(--card); padding: 2rem; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }

        /* --- BOBBY --- */
        .play-btn-wrapper { position: relative; margin: 10px auto 30px; width: 160px; height: 160px; display: flex; justify-content: center; }
        .bobby-box { position: relative; width: 140px; height: 150px; transform-origin: center 85%; transition: transform 0.5s ease; }
        .bird-body { width: 90px; height: 100px; background: var(--bird-grey); border-radius: 50% 50% 45% 45%; position: absolute; left: 25px; top: 10px; z-index: 30; overflow: hidden; }
        .chest { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: var(--bird-orange); border-radius: 50%; transition: filter 0.8s ease-in-out, box-shadow 0.8s ease-in-out;}
        .eye { width: 7px; height: 7px; background: #1a1a1a; border-radius: 50%; transition: all 0.3s; }
        .tail { width: 25px; height: 40px; background: var(--bird-grey); border-radius: 0 0 10px 10px; position: absolute; bottom: 25px; left: 57.5px; z-index: 20; }
        .legs { display: flex; gap: 15px; position: absolute; bottom: 38px; left: 50%; transform: translateX(-50%); z-index: 40; }
        .leg { width: 8px; height: 12px; background: var(--bird-dark-grey); border-radius: 3px; }
        .branch { position: absolute; width: 140px; height: 12px; background: var(--branch-brown); bottom: 35px; left: 0; border-radius: 10px; z-index: 50; }

        .playing .bird-body { animation: breathe 4s ease-in-out infinite; }
        .playing .eye { height: 2px; border-radius: 2px; margin-top: 3px; }
        .sway-active { animation: sway 6s ease-in-out infinite; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
        @keyframes sway { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }

        /* --- ANIMATIONS SPECIFIQUES --- */
        
        /* 1. ZZZ (Bruit Rose) - Retour à l'original */
        .zzz { position: absolute; color: #fb7185; font-weight: bold; opacity: 0; animation: zMove 4s ease-out forwards; font-size: 28px; }
        @keyframes zMove { 
            0% { transform: translate(0, 0) scale(0.5); opacity: 0; } 
            20% { opacity: 1; } 
            100% { transform: translate(40px, -150px) scale(1.5); opacity: 0; } 
        }

        /* 2. VAGUES (Waves) - Remontées */
        .wave-line { 
            position: absolute; left: -10%; width: 120%; height: 120px; 
            background: linear-gradient(0deg, rgba(56, 189, 248, 0.2), transparent);
            border-top: 2px solid rgba(56, 189, 248, 0.4);
            border-radius: 50% 50% 0 0;
            bottom: -20px; /* Remonté pour être plus visible */
            opacity: 0; 
            animation: waveFlow 8s ease-in-out infinite; 
        }
        @keyframes waveFlow { 
            0% { transform: translateX(0) translateY(0); opacity: 0; } 
            50% { opacity: 0.8; transform: translateX(-20px) translateY(-15px); } 
            100% { transform: translateX(-50px) translateY(0); opacity: 0; } 
        }

        /* 3. ESPACE (Space) */
        .astro {
            position: absolute; width: 4px; height: 4px;
            background: white;
            transform: rotate(45deg); /* Losange */
            box-shadow: 0 0 4px white;
            animation: twinkle 3s ease-in-out infinite;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8) rotate(45deg); } 50% { opacity: 1; transform: scale(1.2) rotate(45deg); } }

        /* 4. PLUIE (Rain) - Gouttes nettes */
        .drop {
            position: absolute; width: 6px; height: 12px;
            background: #93c5fd; 
            border-radius: 2px;
            opacity: 0.7;
            transform: rotate(10deg);
            animation: dropFall 0.8s linear infinite;
        }
        @keyframes dropFall {
            0% { transform: translate(0, -20px) rotate(10deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(-10px, 105vh) rotate(10deg); opacity: 0; }
        }

        /* 5. VENT (Wind) - Feuilles */
        .leaf {
            position: absolute; width: 14px; height: 14px;
            border-radius: 0 100% 0 100%; /* Forme de feuille */
            opacity: 0.9; pointer-events: none;
            animation: leafFall 6s linear forwards;
        }
        @keyframes leafFall {
            0% { transform: translate(-50px, -50px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translate(calc(100vw + 50px), calc(100vh + 100px)) rotate(360deg); opacity: 0; }
        }

        /* 6. FEU (Cheminée) - Braises */
        .ember {
            position: absolute; width: 6px; height: 6px;
            background: #fb923c;
            border-radius: 2px; 
            animation: floatUpRotate 4s linear forwards;
        }
        .fire-glow {
            position: absolute; inset: 0; background: radial-gradient(circle at 50% 80%, rgba(234, 88, 12, 0.2), transparent 70%);
            opacity: 0; transition: opacity 2s;
        }
        @keyframes floatUpRotate {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-200px) rotate(180deg); opacity: 0; }
        }

        /* 7. RIVIERE (River) - Eau qui coule */
        .flow-line {
            position: absolute; height: 2px; background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            box-shadow: 0 0 4px #38bdf8;
            animation: flowRight 3s linear infinite;
        }
        @keyframes flowRight {
            0% { transform: translateX(-100px) scaleX(0.5); opacity: 0; }
            20% { opacity: 0.8; transform: translateX(0) scaleX(1); }
            80% { opacity: 0.8; transform: translateX(50vw) scaleX(1); }
            100% { transform: translateX(calc(100vw + 50px)) scaleX(0.5); opacity: 0; }
        }

        /* 8. RUISSEAU (Stream) - Particules montantes */
        .stream-speck {
            position: absolute; width: 4px; height: 4px;
            background: #bae6fd; /* Bleu très clair */
            border-radius: 50%;
            box-shadow: 0 0 6px #7dd3fc;
            animation: riseHigh 6s ease-out forwards;
        }
        @keyframes riseHigh {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(-75vh) translateX(20px); opacity: 0; } /* Monte haut */
        }
        
        /* UI */
        .label-row { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; opacity: 0.7; margin-bottom: 5px; }
        .control-group { text-align: left; margin-top: 18px; }
        select { width: 100%; padding: 12px; border-radius: 12px; background: #2d3748; border: 1px solid rgba(255,255,255,0.1); color: white; appearance: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="anim-container" id="bgAnimContainer"></div> 
    <div class="anim-container" id="animContainer"></div>    
    <div class="container">
        <div class="card">
            <h2 style="margin:0;">Sleepy Bobby</h2>
            <p id="bobbyPhrase" style="min-height:50px; font-size: 0.95rem; font-style: italic; margin: 10px 0; display: flex; align-items: center; justify-content: center;"></p>
            
            <div class="play-btn-wrapper">
                <div class="bobby-box" id="bobbyBox">
                    <div class="tail"></div>
                    <div class="bird-body" id="birdMain">
                        <div style="position:absolute;top:0;left:20%;width:60%;height:25px;background:var(--bird-dark-grey);border-radius:0 0 15px 15px;"></div>
                        <div class="chest" id="bChest"></div>
                        <div style="position:absolute;top:35px;width:45px;display:flex;justify-content:space-between;left:50%;transform:translateX(-50%);"><div class="eye"></div><div class="eye"></div></div>
                        <div style="position:absolute;top:42px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:7px solid #f1c40f;"></div>
                    </div>
                    <div class="legs"><div class="leg"></div><div class="leg"></div></div>
                    <div class="branch"></div>
                    <button id="playBtn" style="position:absolute; inset:0; background:none; border:none; cursor:pointer; z-index:100;"></button>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Ambiance</span></div>
                <select id="modeSelect">
                    <option value="stream">Ruisseau</option>
                    <option value="river">Rivière</option>
                    <option value="pink">Bruit Rose</option>
                    <option value="waves">Vagues</option>
                    <option value="rain">Pluie</option>
                    <option value="storm">Orage</option>
                    <option value="wind">Vent</option>
                    <option value="fire">Cheminée</option>
                    <option value="space">Espace</option>
                </select>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Minuteur</span></div>
                <select id="timerSelect">
                    <option value="0" data-base="Désactivé (∞)">Désactivé (∞)</option>
                    <option value="5" data-base="5 Minutes">5 Minutes</option>
                    <option value="15" data-base="15 Minutes">15 Minutes</option>
                    <option value="30" data-base="30 Minutes">30 Minutes</option>
                    <option value="60" data-base="60 Minutes">60 Minutes</option>
                </select>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Volume <span id="volPerc">100%</span></span></div>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1.0" style="width:100%">
            </div>
        </div>
    </div>
<audio id="silentPlayer" loop style="display:none;">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA" type="audio/wav">
</audio>
<script>
    // --- CONFIGURATION ---
    const phrases = [
        "Bobby ébouriffe ses plumes pour te border.", "Chut... Bobby troque son chant contre un doux murmure.",
        "Un petit nid de sons pour une grande nuit de rêves.", "Bobby ferme un œil... puis l'autre... avec toi.",
        "Bobby says bonne nuit and wishes you sweet dreams.", "Un battement d'ailes, un petit chirp, et hop au dodo !",
        "Bobby is learning to snore in two languages.", "Bobby has his head in the clouds, entre Dublin et Paris.",
        "Bobby range son bec sous son aile, c'est l'heure.", "Le dernier rouge-gorge couché éteint la lune !",
        "Bobby rêve de trèfles irlandais et de jardins français.", "De Connemara à la Provence, Bobby te chante le sommeil.",
        "A little piece of Ireland, un petit coin de France, et beaucoup de dodo.", "Slán abhaile... Bobby te souhaite un doux retour au pays des songes."
    ];

    // --- VARIABLES GLOBALES ---
    let visualInterval, countdownInterval, fxInterval;
    let isPlaying = false;
    let audioCtx, masterGain, currentSource;
    let audioBuffers = {}; 
    let endTime = 0;

    // FICHIERS AUDIO
    const SOUND_FILES = {
        stream: 'res/813251__nicktayloe__cave-stream-loop.wav', 
        river: 'res/443869__eardeer__water_flow_dam_distant_loop.wav', 
        pink: 'res/349312__newagesoup__pink_noise-10s.wav', 
        waves: 'res/829626__ocean.wav',
        rain: 'res/66472__digifishmusic__rain_on_a_tin_roof_loop.wav',
        storm: 'res/66472__digifishmusic__rain_on_a_tin_roof_loop.wav', 
        wind: 'res/651545__nsstudios__wind-draft-loop-3.wav', 
        fire: 'res/612277__robinhood76__10835-big-fire-loop.wav', 
        space: 'res/676854__darrenpasemko__wind_looping_01.wav'
    };

    const FX_FILES = {
        thunder: 'res/778363__blondpanda__distant_rumbling_thunder_in_rain_02.wav',
        crackle: 'res/823274__hannagreen__sparks_mediumdensity3.wav' 
    };

    // --- FONCTIONS UI ---
    function displayNewPhrase() { 
        document.getElementById('bobbyPhrase').textContent = phrases[Math.floor(Math.random() * phrases.length)]; 
    }
    
    function resetTimerLabels() { 
        const s = document.getElementById('timerSelect'); 
        Array.from(s.options).forEach(o => o.text = o.getAttribute('data-base')); 
    }

    // --- MOTEUR AUDIO ---
    async function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
            updateVolume(document.getElementById('volume').value);
        }
        if (audioCtx.state === 'suspended') await audioCtx.resume();
    }

    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        
        const phraseBox = document.getElementById('bobbyPhrase');
        const originalText = phraseBox.textContent;
        phraseBox.textContent = "Chargement...";

        try {
            console.log("Tentative de chargement : " + url);
            const response = await fetch(url);
            
            if (!response.ok) throw new Error(`Fichier introuvable (${response.status})`);
            
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("text/html")) throw new Error("Erreur 404 (Fichier non trouvé)");

            const arrayBuffer = await response.arrayBuffer();
            const decodedData = await audioCtx.decodeAudioData(arrayBuffer);
            audioBuffers[url] = decodedData;
            phraseBox.textContent = originalText;
            return decodedData;

        } catch (e) {
            console.error("ERREUR CRITIQUE:", e);
            phraseBox.innerHTML = `<span style="color:#fb7185; font-size:0.8em">Erreur: ${url} introuvable !</span>`;
            return null;
        }
    }

    async function playOneShot(key) {
        if (!isPlaying) return;
        const buffer = await getAudioBuffer(FX_FILES[key]);
        if (!buffer) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        const fxGain = audioCtx.createGain();
        fxGain.gain.value = 0.6; 
        source.connect(fxGain);
        fxGain.connect(masterGain);
        source.start(0);
    }

    async function startAudio(mode) {
        await initAudio();
        stopAudio(false); 

        const loopUrl = SOUND_FILES[mode];
        if (!loopUrl) return;

        const buffer = await getAudioBuffer(loopUrl);
        if (!buffer) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.loop = true; 
        
        const v = document.getElementById('volume').value;
        masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
        masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
        masterGain.gain.linearRampToValueAtTime(parseFloat(v), audioCtx.currentTime + 1.5);

        source.connect(masterGain);
        source.start(0);
        currentSource = source;

        if (mode === 'storm') fxLoop('thunder', 8000, 20000);
        else if (mode === 'fire') fxLoop('crackle', 3000, 10000);
    }

    function fxLoop(fxName, minTime, maxTime) {
        const delay = minTime + Math.random() * (maxTime - minTime);
        fxInterval = setTimeout(() => {
            if (isPlaying) {
                playOneShot(fxName);
                fxLoop(fxName, minTime, maxTime);
            }
        }, delay);
    }

    function stopAudio(fullStop = true) {
        if (currentSource) {
            try {
                masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
                masterGain.gain.setValueAtTime(masterGain.gain.value, audioCtx.currentTime);
                masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                const oldSource = currentSource;
                setTimeout(() => { try { oldSource.stop(); oldSource.disconnect(); } catch(e){} }, 600);
            } catch (e) {}
            currentSource = null;
        }
        if (fxInterval) clearTimeout(fxInterval);
        
        if (fullStop && 'mediaSession' in navigator) {
            navigator.mediaSession.playbackState = "none";
        }
    }

    function updateVolume(val) {
        if (masterGain) {
            masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
            masterGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
        }
    }

    // --- MEDIA SESSION ---
    function updateMediaSession(modeKey) {
        if ('mediaSession' in navigator) {
            const modeNames = {
                stream: "Ruisseau", river: "Rivière", pink: "Bruit Rose",
                waves: "Vagues", rain: "Pluie", storm: "Orage",
                wind: "Vent", fire: "Cheminée", space: "Espace"
            };
            
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'Sleepy Bobby',
                artist: modeNames[modeKey] || 'Relaxation',
                album: 'Ambiance Naturelle',
                artwork: [{ src: 'icon.png', sizes: '512x512', type: 'image/png' }]
            });

            navigator.mediaSession.setActionHandler('play', () => { if(!isPlaying) startBobby(); });
            navigator.mediaSession.setActionHandler('pause', () => { if(isPlaying) stopBobby(); });
            navigator.mediaSession.setActionHandler('stop', stopBobby);
            navigator.mediaSession.playbackState = "playing";
        }
    }

    async function startBobby() {
        if(isPlaying) {
            stopBobby();
            return;
        }

        const silentPlayer = document.getElementById('silentPlayer');
        try {
            silentPlayer.volume = 1.0; 
            await silentPlayer.play();
        } catch(e) { console.error("Erreur silent player", e); }

        isPlaying = true;
        displayNewPhrase();
        document.getElementById('playBtn').innerHTML = ""; 
        document.getElementById('bobbyBox').classList.add('playing');
        
        const mode = document.getElementById('modeSelect').value;
        updateMediaSession(mode);

        await startAudio(mode);
        updateVisuals();

        const s = document.getElementById('timerSelect');
        const selectedOption = s.options[s.selectedIndex];
        let mins = parseInt(s.value);
        if (mins > 0) {
            endTime = Date.now() + (mins * 60 * 1000);
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((endTime - now) / 1000);
                if (diff <= 0) stopBobby();
                else {
                    let m = Math.floor(diff / 60);
                    let sec = diff % 60;
                    selectedOption.text = `${m}:${sec < 10 ? '0' : ''}${sec} restant`;
                }
            }, 1000);
        }
    }

    function stopBobby() {
        isPlaying = false;
        
        const silentPlayer = document.getElementById('silentPlayer');
        silentPlayer.pause();
        silentPlayer.currentTime = 0;

        stopAudio(true);
        
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";

        document.getElementById('bobbyBox').classList.remove('playing', 'sway-active');
        clearInterval(visualInterval);
        clearInterval(countdownInterval);
        
        document.getElementById('animContainer').innerHTML = '';
        document.getElementById('bgAnimContainer').innerHTML = '';
        document.getElementById('birdMain').style.boxShadow = "none";
        document.getElementById('bChest').style.filter = "none";
        resetTimerLabels();
    }

    function updateVisuals() {
        const f = document.getElementById('animContainer');
        const b = document.getElementById('bgAnimContainer'); 
        const m = document.getElementById('modeSelect').value;
        
        // Nettoyage
        f.innerHTML = ''; 
        b.innerHTML = ''; 
        clearInterval(visualInterval);
        
        // Reset classes Bobby
        const box = document.getElementById('bobbyBox');
        box.classList.remove('sway-active');
        document.getElementById('bChest').style.filter = "none";

        // --- VISUELS STATIQUES DE FOND ---
        if (m === 'space') {
             for(let i=0; i<30; i++) { 
                let s = document.createElement('div');
                s.className = 'astro';
                s.style.left = Math.random()*100+'%';
                s.style.top = Math.random()*100+'%';
                s.style.animationDelay = Math.random()*3+'s';
                let scale = 0.5 + Math.random();
                s.style.width = s.style.height = (4 * scale) + 'px';
                b.appendChild(s); 
            }
        }
        
        if (m === 'waves') {
            // Vagues remontées, plus de bulles
            for(let i=0;i<3;i++){
                let w=document.createElement('div');
                w.className='wave-line';
                w.style.animationDelay=(i*3)+'s';
                b.appendChild(w);
            }
        }

        // --- BOUCLE D'ANIMATION (Objets dynamiques) ---
        visualInterval = setInterval(() => {
            if(!isPlaying) return;
            
            // 1. VENT (Restauré)
            if (m === 'wind') {
                let el = document.createElement('div'); el.className='leaf';
                el.style.left = Math.random()*100+'%'; el.style.top='-20px';
                el.style.backgroundColor=['#4ade80', '#22c55e', '#86efac'][Math.floor(Math.random()*3)];
                f.appendChild(el); setTimeout(()=>el.remove(), 6000);
            
            // 2. PLUIE / ORAGE
            } else if (m === 'rain' || m === 'storm') {
                for(let k=0; k<2; k++){
                    let el = document.createElement('div'); el.className='drop';
                    el.style.left = Math.random()*100+'%'; 
                    el.style.top = '-20px';
                    el.style.animationDuration = (0.6 + Math.random()*0.3) + 's';
                    f.appendChild(el); setTimeout(()=>el.remove(), 1000);
                }

            // 3. FEU
            } else if (m === 'fire') {
                 if (!b.querySelector('.fire-glow')) { let glow = document.createElement('div'); glow.className = 'fire-glow'; b.appendChild(glow); setTimeout(() => glow.style.opacity = 1, 10); }
                 let el = document.createElement('div'); el.className='ember';
                 el.style.left = (45 + Math.random()*10) + '%'; 
                 el.style.bottom = '15%';
                 el.style.background = ['#fb923c', '#fca5a5', '#fdba74'][Math.floor(Math.random()*3)];
                 f.appendChild(el); setTimeout(()=>el.remove(), 4000);
                 const i = 0.9 + Math.random() * 0.3; document.getElementById('bChest').style.filter = `brightness(${i}) saturate(1.2)`;
            
            // 4. RIVIERE (Eau qui coule)
            } else if (m === 'river') {
                let el = document.createElement('div'); el.className='flow-line';
                el.style.left = '-100px'; 
                el.style.top = (60 + Math.random()*40) + '%'; // Partie basse
                el.style.width = (50 + Math.random()*100) + 'px';
                f.appendChild(el); setTimeout(()=>el.remove(), 3000);

            // 5. RUISSEAU (Remonté et plus visible)
            } else if (m === 'stream') {
                let el = document.createElement('div'); el.className='stream-speck';
                el.style.left = Math.random()*100+'%';
                el.style.bottom = '0';
                f.appendChild(el); setTimeout(()=>el.remove(), 6000);

            // 6. BRUIT ROSE (Restauré zZz)
            } else if (m === 'pink') {
                let el = document.createElement('div'); el.className='zzz'; 
                el.textContent = 'z';
                el.style.left = (45 + Math.random()*10) + '%'; 
                el.style.top = '40%';
                f.appendChild(el); setTimeout(()=>el.remove(), 4000);
            }

        }, m === 'rain' || m === 'storm' ? 100 : 
           m === 'stream' ? 400 : // Plus de particules pour le ruisseau
           m === 'river' ? 300 : // Rivière fluide
           600); 

        // Mouvement de Bobby seulement pour le vent
        if (m === 'wind') box.classList.add('sway-active');
    }

    document.getElementById('timerSelect').addEventListener('change', () => { if (isPlaying) startBobby(); });
    document.getElementById('playBtn').addEventListener('click', () => startBobby());
    document.getElementById('modeSelect').addEventListener('change', () => { if(isPlaying) startBobby(); });
    document.getElementById('volume').addEventListener('input', (e) => {
        document.getElementById('volPerc').textContent = Math.round(e.target.value * 100) + "%";
        updateVolume(e.target.value);
    });

    displayNewPhrase();
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => { });
</script>
</body>
</html>